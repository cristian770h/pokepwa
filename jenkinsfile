pipeline {
    agent any



    tools {
        nodejs 'node-20' 
    }

    environment {
        VERCEL_TOKEN = credentials('vercel-token')
        VERCEL_ORG_ID = credentials('vercel-org-id')
        VERCEL_PROJECT_ID = credentials('vercel-project-id')
        SCANNER_HOME = tool 'sonar-scanner'
    }

    stages {
        stage('1. Checkout y Setup') {
            steps {
                checkout scm
                sh 'npm ci' 
            }
        }

        stage('2. Análisis de Código (SonarQube)') {
            steps {
                script {
                    // Paso A: Iniciar el escáner y enviarlo a SonarQube
                    withSonarQubeEnv('sonarqube-docker') { 
                        sh """
                        $SCANNER_HOME/bin/sonar-scanner \
                        -Dsonar.projectKey=pokemon-pwa \
                        -Dsonar.sources=src \
                        -Dsonar.host.url=http://host.docker.internal:9000 \
                        -Dsonar.token=jenkins-token 
                        """
                        // NOTA: Si usaste token en la config de Jenkins, borra la linea -Dsonar.token
                    }
                }
            }
        }

        stage('3. Verificación de Calidad (Quality Gate)') {
            steps {
                // Paso B: PAUSA el pipeline hasta que SonarQube responda por el Webhook
                timeout(time: 2, unit: 'MINUTES') {
                    // abortPipeline: true hace que se ponga ROJO si falla la calidad
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('4. Despliegue a Producción') {
            // Esta lógica decide si se despliega o no
            when {
                allOf {
                    branch 'main' // SOLO si la rama es main
                    // Si tu rama se llama 'master', cambia 'main' por 'master' arriba
                }
            }
            steps {
                echo "¡Estamos en la rama Main y la Calidad pasó! Desplegando..."
                sh 'npm install -g vercel'
                echo "Desplegando a Vercel..."
        // Este comando es el que imprime el LINK al final
        sh "vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN"
                
                sh """
                    vercel pull --yes --environment=production --token=$VERCEL_TOKEN
                    vercel build --prod --token=$VERCEL_TOKEN
                    vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
                """
            }
        }
    }
}